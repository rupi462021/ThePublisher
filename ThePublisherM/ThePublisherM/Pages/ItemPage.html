<!DOCTYPE html>
<html lang="en">
<head>
    <title>Show Room</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link href="style.css" rel="stylesheet" />

    <!--<link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">-->

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!--<script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>-->

    <script src="https://apis.google.com/js/api.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>

    <script src="https://apis.google.com/js/api.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <link href="style.css" rel="stylesheet" />
    <script src="../Scripts/ajaxCalls.js"></script>

    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></script>-->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.rawgit.com/oauth-io/oauth-js/c5af4519/dist/oauth.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-social/4.12.0/bootstrap-social.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
    <!--<script src="https://vjs.zencdn.net/ie8/ie8-version/videojs-ie8.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/5.14.1/videojs-contrib-hls.js"></script>-->
    <script src="https://vjs.zencdn.net/7.2.3/video.js"></script>
    <link href="https://vjs.zencdn.net/7.2.3/video-js.css" rel="stylesheet">
    <script src="../Scripts/jquery-3.6.0.js"></script>
    <script src="../Scripts/jquery-3.6.0.min.js"></script>


    <style type="text/css">
        #itemsDiv {
            background-color: #aecfd0;
        }

        #search_item {
        }
        body{
            text-align:right;
        }
        .fa {
            padding: 5px;
            /*font-size: 30px;*/
            width: 30px;
            text-align: center;
            text-decoration: none;
            margin: 5px 2px;
            border-radius: 50%;
        }
            .fa:hover {
                opacity: 0.7;
            }

        .fa-facebook {
            background: #3B5998;
            color: white;
        }
        .fa-twitter {
            background: #55ACEE;
            color: white;
        }
        .fa-instagram {
            background: #125688;
            color: white;
            
        }
        #twitter-button {
            background-color: dodgerblue;
            color: white;
            border-radius: 5px;
            width: fit-content;
        }
        .btn {
            color: white;
            
        }
        button#saveItem {
            border-radius: 8px;
            background-color:whitesmoke;
            color: black;
            font-size: medium;
        }

    </style>
    <!--<link href="ItemPageStyle.css" rel="stylesheet" />-->
    <link href="ItemPageStyle.css" rel="stylesheet" />
    <script>
        $(document).ready(function () {
            console.log("ready!");
            $('#twitter-button').on('click', function () {
                // Initialize with your OAuth.io app public key
                OAuth.initialize('V4oF97dwIJsnASOirzOIn29X_cA');
                // Use popup for OAuth
                OAuth.popup('twitter').then(twitter => {
                    console.log(twitter);
                    // Retrieves user data from oauth provider
                    console.log(twitter.me());
                });
            });
           
            checkUser();
            $("#logOut").click(function () {
                document.location = "login.html";
                localStorage.clear();
            });
            $("#getShow").click(showRend);
            $("#saveItem").click(saveItemD);
            $("#testg").click(showVideoTitle);
            /*$("#homepage").submit(sendUrl);*/
        });
        function checkUser() {
            if (localStorage["userObject"] != null) {
                tastStr = JSON.parse(localStorage["userObject"]);
                $("#userName").append(tastStr.email);
            }
            else {
                tastStr = [];
            }
        }
        //function sendUrl() {
        //    var home = $("#homepage").val();
        //    console.log(home);
        //    video = `<video id="hls" class="video-js vjs-default-skin" width="400" height="300" controls>
        //        <source type="application/x-mpegURL" src="${home}">
        //        </video>`
        //}
        //in Success geting the show details from the xml file
        function showRend() {
            console.log("in rend");
            let api = "../api/Item";
            ajaxCall("GET", api, "", getShowSuccess, getShowError);
        }
        function getShowError(err) {
            console.log(err);
        }
        function getShowSuccess(data) {
            console.log(data);
            console.log("in Success");
            Data = data;
            $("#showItems").empty();
            $("#showItems").html("");
            str = "";
            for (var i = 0; i < Data.length; i++) {
                str += "<div id='accordion'>";
                str += "<div id='" + i + "' class='card'><div class='card-header'>";
                str += "<a class='card-link' data-toggle='collapse' href='#collapseOne'>"
                    + Data[i].ShowTitle + "</a >";
                str += "<a href='#' id='" + i + "' class='btn btn-primary' onclick='sendText(this)'>" + " עריכה " + "</a>";
                str += "<div id='collapseOne' id='" + i + "' class='collapse show' data-parent='#accordion'>";
                str += "<div class='card-body'><p>מספר תוכנית: " + Data[i].ShowId + "</p>";
                str += "<p class='scriptName'>" + Data[i].StoryName + "</p>";
                str += "<p> פורמט: " + Data[i].StoryFormat + "</p>";
                str += "<p class='scriptC'>" + Data[i].StoryScript + "</p>";
                str += "<p class='scriptId'>" + Data[i].StoryId + "</p>";
                str += "</div></div>";
                str += "</div></div>";
                str += "</div>";
            }
            $("#showItems").append(str);
        }
        //in Success geting the videos from data

        function sendText(cntrl) {
            console.log("in send");
            var by = cntrl.id;
            var tit = $("p.scriptName");
            var sid = $("p.scriptId");
            var desc = $("p.scriptC");
            $("#title-input").val(tit[by].innerHTML);
            $("#id-input").val(sid[by].innerHTML);
            $("#desc-input").val(desc[by].innerHTML + document.getElementById('vid_lbl').innerHTML);
        }
        /*chance*/
        let arr = [];
        function showVideoTitle() {
            console.log("in rend");
            let date = $("#dateTime").val();
            let startDate = $("#startTime").val();
            let endDate = $("#endTime").val();
            console.log(endDate);
            let api = "../api/Videos?from=" + startDate + "&to=" + endDate + "&date=" + date;

            ajaxCall("GET", api, "", suc, err);
        }
        function suc(data) {
            $("#aaa").html('').append($('', { src: 'blah.gif' }));
            console.log("yess")
            console.log(data);
            arr = JSON.parse(data);
            console.log(arr.GetPlaybackResult.Result);

            //document.getElementById('vid_lbl').innerHTML = arr.GetPlaybackResult.Result;

            /*document.getElementById('vid_lbl').innerHTML = "http://..";*/
            video = `<video id="hls" class="video-js vjs-default-skin" width="400" height="300" controls>
                <source type="application/x-mpegURL" src="${arr.GetPlaybackResult.Result}">
                </video>`
            $("#aaa").append(video);
            var player = videojs('hls');
            player.play();
            //video = `<video id="my-video"
            //                                                class="video-js"
            //                                                controls
            //                                                preload="auto"
            //                                                width="720px"
            //                                                height="264"


            //                                                data-setup="{}">
            //                                                <source src=${arr.GetPlaybackResult.Result} type="video/mp4" />


            //                                            </video>`
            //$("#aaa").append(video);
            /*console.log("<a href='${ arr.GetPlaybackResult.Result }'></a>");*/
            //let attst = arr["GetPlaybackResult"].Result;
            //video.src = attst;
            //console.log(attst);
            //var videoUrl = createObjectURL(attst);
            //console.log(videoUrl);


        }
        function err(err) {
            console.log(err);
        }

        //save the item details and show in item save page
        function saveItemD() {
            console.log("in save item");
            let _title = $("#title-input").val();
            let _storyNum = $("#id-input").val();
            let _description = $("#desc-input").val();
            let link = document.getElementById('vid_lbl').innerHTML;
            let savedItem = { // Note that the name of the fields must be identical to the names of the properties of the object in the server

                Title: _title,
                StoryNum: _storyNum,
                Description: _description,
                Link: link
            }
            ajaxCall("POST", "../api/SavedItem", JSON.stringify(savedItem), postSaveSuccess, postSaveError);
        }
        function postSaveSuccess(data) {
            swal("Added Successfuly!", "Great Job", "success");
            console.log(data);
        }
        function postSaveError(err) {
            swal("This item has been saved!", "Select another item");
            console.log(err.responseJSON);
        }
        function sendPost(msg) {
            let pageId = "104598111726735";
            console.log("trying to get page id from facebook API");
            let user_token = sessionStorage.getItem("token");
            let userID = sessionStorage.getItem("userID");
            //try to get page access token
            let url_get_page_access = "https://graph.facebook.com/" + pageId + "?fields=access_token&access_token=" + user_token;
            let page_acces_token = httpGet(url_get_page_access);
            var resp = JSON.parse(page_acces_token);
            let postUrl = "https://graph.facebook.com/" + pageId + "/feed?message=" + document.getElementById('desc-input').value + "&access_token=" + resp.access_token;
            let res = httpPost(postUrl);
            console.log(res);
        }
        // function for posting in twitter!!should be comm
        function sendPostTwitt(cntr) {
            /*alert("Twitter!");*/
            console.log("trying to get page id from twitter API");
            let apiTwit = "../api/Twitter";
            ajaxCall("GET", apiTwit, "", RequestTwittSuccess, RequestTwittError);
        }
        function sendPostInstagram() {
            let ig_user_id = "17841447421624560";
            let user_token = sessionStorage.getItem("token");
            let message = document.getElementById('desc-input').value;
            let mockupVideoUrl = "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4";

            let createContainerReq = "https://graph.facebook.com/" + ig_user_id + "/media?media_type=VIDEO&video_url=" + mockupVideoUrl + "&caption=" + message + "&access_token=" + user_token;

            let tryGetContainerId = httpPost(createContainerReq);
            var resp = JSON.parse(tryGetContainerId);
            if (resp.id) {
                let checkContainerStatusReq = "https://graph.facebook.com/" + resp.id + "?fields=status_code&access_token=" + user_token;

                var interval = setInterval(check, 1000);
                var tryCheck = undefined;
                function check() {
                    tryCheck = httpGet(checkContainerStatusReq);
                    var constatus = JSON.parse(tryCheck);
                    if (constatus.status_code) {
                        if (constatus.status_code == "FINISHED") {
                            clearInterval(interval);
                            let publishReq = "https://graph.facebook.com/" + ig_user_id + "/media_publish?creation_id=" + resp.id + "&access_token=" + user_token;
                            let tryPublish = httpPost(publishReq);
                            var publichResponse = JSON.parse(tryPublish);
                            if (publichResponse.id) {
                                //published successfully
                                console.log("published successfully");
                            }

                        }
                        else if (constatus.status_code != "IN_PROGRESS") {
                            //show error to user
                            clearInterval(interval);
                        }
                    }
                    else {
                        //show error to user
                        clearInterval(interval);
                    }
                }
            }
        }

        // the request twitter
        function RequestTwittSuccess(data) {
            console.log("Success!!!");
            console.log(data);
            DataT = data;
            postUrlTwitt = "https://twitter.com/intent/tweet?text=" + document.getElementById('desc-input').value + "&access_token=" + DataT;
            console.log(postUrlTwitt);
            TwitterWindow = window.open(postUrlTwitt, 'TwitterWindow', true);

        }
        // the request to post twitter
        function RequestTwittError(err) {
            console.log(err);
        }
        function httpGet(url) {
            var xml = new XMLHttpRequest();
            xml.open('GET', url, false);
            xml.send(null);
            console.log(xml.responseText);
            return xml.responseText;
        }
        function httpPost(url) {
            var xml = new XMLHttpRequest();
            xml.open('POST', url, false);
            xml.send();
            return xml.responseText;
        }
        window.fbAsyncInit = function () {
            FB.init({
                appId: '304468051299771',
                cookie: true,
                xfbml: true,
                version: 'v10.0'
            });
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        };
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function statusChangeCallback(response) {
            if (response.status == "connected") {
                console.log("connected")
                sessionStorage.setItem("token", response.authResponse.accessToken);
                sessionStorage.setItem("userID", response.authResponse.userID);
            }
            else {
                console.log("not-connected")
                sessionStorage.clear();
            }
            console.log(response);
        }
        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }


    </script>
</head>
<body>
    <div class="jumbotron text-center" style="margin-bottom:0">
        <img src="../Images/1200px-Kan11Logo.svg.png" width="150" height="100" />
    </div>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <a class="navbar-brand" href="#" onclick="document.location='MainPage.html'">ראשי</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="#">יצירת אייטם</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="document.location='SavedItems.html'">אייטמים שנשמרו</a>
            </li>
            <!--<li class="nav-item">
                <a class="nav-link" href="#" onclick="document.location='videoPage.html'">וידאו</a>
            </li>-->
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="document.location='Managerlogin.html'">כניסת מנהל</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="document.location='TwitterAnalytics.html'">ניתוחים</a>
            </li>
            <li class="nav-item" style="float:left">
                <a class="nav-link" id="userName" href="#"></a>
            </li>
            <li class="nav-item" style="float:left">
                <a class="nav-link" id="logOut" href="#">התנתק</a>
            </li>
        </ul>
    </nav>
    <div class="container" style="margin-top:20px">
        <div class="row">
            <div class="col-sm-4" id="itemsDiv">
                <div class="list">
                    <div class="list-head">
                        <h2>תוכניות</h2>
                        <button id="getShow" type="button" class="btn btn-primary">ייבא תכנים</button>
                    </div>
                    <div class="fakeimg">
                        <br>
                        <div id="showItems"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <p>בחר קובץ להעלאה:</p>
                <div class="search_video">


                    <h5>בחר שעת תוכנית</h5>
                    <div class="form-group">

                        <label for="dealerPhone"><span class="red-star">★ </span> תאריך:</label>
                        <!--<label for="dealerPhone">Phone Number (In Format ddd-ddddddd )</label>-->
                        <input type="date" class="form-control" placeholder="Enter date" id="dateTime"
                               pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}"
                               oninvalid="this.setCustomValidity('Phone Number pattern Is Not Valid')"
                               oninput="this.setCustomValidity('')" required />
                    </div>

                    <div class="form-group">

                        <label for="dealerPhone"><span class="red-star">★ </span>זמן התחלה:</label>
                        <!--<label for="dealerPhone">Phone Number (In Format ddd-ddddddd )</label>-->
                        <input type="time" class="form-control" placeholder="Enter start time" id="startTime" name="startime"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="dealerPhone"><span class="red-star">★ </span>זמן סיום:</label>
                        <input type="time" class="form-control" placeholder="Enter end time" id="endTime" name="endtime"
                               required />
                    </div>

                    
                    <button onclick="showVideoTitle()" id="testg">חיתוך</button>

                    <div id="aaa">


                    </div>

                    <div id="frame" class="search_item">
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="content-form">
                                <div>
                                    <label for="title-input">שם תכנית</label>
                                    <input id="title-input" type="text" name="title-input" value="" /><br>
                                    <label for="id-input">מספר תכנית</label>
                                    <input id="id-input" type="text" name="id-input" value="" />
                                    <br />
                                    <label id="vid_lbl"></label>
                                </div>
                                <div>
                                    <label for="desc-input">תאור</label>
                                    <textarea id="desc-input" name="desc-input" rows="10" cols="40"></textarea>
                                </div>

                                <div id="social">

                                    <fb:login-button scope="public_profile,email"
                                                     onlogin="checkLoginState();">
                                    </fb:login-button>

                                    <button id="twitter-button">Log In<i class="fa fa-twitter"></i> </button>
                                    
                                </div>


                                <div id="social_groupBTN">
                                    <button id="saveItem">Save Item</button>
                                    <button onclick="sendPost('TBD')" id="testBtn" class="fa fa-facebook"></button>
                                    <button onclick="sendPostInstagram()" id="testBtn" class="fa fa-instagram"></button>
                                    <button onclick="sendPostTwitt('TBDT')" id="testBtn1" class="fa fa-twitter"></button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <br />

                </div>
        </div>
    </div>

        <div class="row">
            <div class="col-sm-4">
            </div>
            <div class="col-sm-8">
            </div>
        </div>
    

        <div class="jumbotron text-center" style="margin-bottom:0">
            <div class="row">
                <div class="col-sm-4">
                    <img id="logo_kan" src="../Images/1200px-Kan11Logo.svg.png" width="40" height="40" />
                    <br />
                    <a href="https://www.kan.org.il/">www.kan.org.il</a>
                </div>
            </div>
        </div>
</body>
</html>
